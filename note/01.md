

# è¿è¡Œ

ç»ˆç«¯è¿è¡Œnode æ–‡ä»¶å

**nodemonå®ç°è‡ªåŠ¨æ›´æ–°**

ç»ˆç«¯è¿è¡Œnodemon æ–‡ä»¶å

# åŸºç¡€

requestä¸­æœ‰ä¸‰ä¸ªé‡è¦çš„å±æ€§ï¼šurlã€methodã€headers

responseè®¾ç½®å¤´éƒ¨æœ‰ä¸¤ç§æ–¹æ³•ï¼š**writeHeadå’ŒsetHeader**

å…¶ä¸­writeHeadæ˜¯åˆå¹¶å†™æ³•ï¼š

```
response.writeHead(200,{
  "Content-Type":'text/html'
})
```

setHeadæ˜¯åˆ†å¼€å†™æ³•ï¼š

```
response.statusCode = 200
response.setHeader = {'Content-Type','text/html'}
```



```js
åŸºæœ¬æ ¼å¼ï¼š
const http = require('http')
const path = require('path')
const URL = require('url')

const server = http.createServer((request,response)=>{
    //è§£æ„èµ‹å€¼
    const {url,method,headers} = request
    if(url==='/'&&method==='GET'){
        fs.readFile('index.html',(err,data)=>{
           response.writeHead(200,{
            'Content-Type':'text/html'
           })
           response.end(data)
        })
    }
})
```

## è¯·æ±‚æŠ¥æ–‡å’Œå“åº”æŠ¥æ–‡

**è¯·æ±‚æ–¹å¼ï¼š**GETã€POST

**è¯·æ±‚åœ°å€ï¼š**

```
     req.headers  // è·å–è¯·æ±‚æŠ¥å¤´
     req.url      // è·å–è¯·æ±‚åœ°å€
     req.method   // è·å–è¯·æ±‚æ–¹æ³•
```

å“åº”æŠ¥æ–‡ï¼š

**HTTPçŠ¶æ€ç ï¼š**

200 è¯·æ±‚æˆåŠŸ

404 è¯·æ±‚çš„èµ„æºæ²¡æœ‰è¢«æ‰¾åˆ°

500 æœåŠ¡å™¨ç«¯é”™è¯¯

400 å®¢æˆ·ç«¯è¯·æ±‚æœ‰è¯­æ³•é”™è¯¯

**å†…å®¹ç±»å‹**ï¼š

text/html

text/css

application/javascript

image/jpeg

application/json

## HTTPè¯·æ±‚å’Œå“åº”å¤„ç†

1.GETè¯·æ±‚å‚æ•°

- å‚æ•°è¢«æ”¾ç½®åœ¨æµè§ˆå™¨åœ°å€æ ä¸­ï¼Œä¾‹å¦‚ï¼šhttp://localhost:3000/?name=zhangsan&age=20
- å‚æ•°è·å–éœ€è¦å€ŸåŠ©ç³»ç»Ÿæ¨¡å—urlï¼Œurlæ¨¡å—ç”¨æ¥å¤„ç†urlåœ°å€

```js
const http = require('http');
 // å¯¼å…¥urlç³»ç»Ÿæ¨¡å— ç”¨äºå¤„ç†urlåœ°å€
 const url = require('url');
 const app = http.createServer();
 app.on('request', (req, res) => {
     // å°†urlè·¯å¾„çš„å„ä¸ªéƒ¨åˆ†è§£æå‡ºæ¥å¹¶è¿”å›å¯¹è±¡
         // true ä»£è¡¨å°†å‚æ•°è§£æä¸ºå¯¹è±¡æ ¼å¼
     let {query} = url.parse(req.url, true);
     console.log(query);
     //æˆ–è€…ç›´æ¥æ‹¿åˆ°3000åçš„è·¯å¾„
     let pathname = url.parse(req.url).pathname
 });
 app.listen(3000);

```

2.POSTè¯·æ±‚

- å‚æ•°æ”¾åœ¨è¯·æ±‚ä½“ä¸­
- å‚æ•°è·å–éœ€è¦å€ŸåŠ©querystringæ¨¡å—

```js
else if (url === '/info' && method === 'POST') {
    let postData = ''
    request.on('data', (chunk) => (postData += chunk))
    request.on('end', () => {
      console.log(querystring.parse(postData))
    })
    response.statusCode = 200
    response.setHeader = {
      'Content-Type': 'application/json',
    }
    response.end('infoé¡µ')
  }
```

htmlé¡µï¼š

```html
 <body>
    <form action="">
      <input type="text" name="" id="my" value="" placeholder="ç”¨æˆ·å" />
      <input type="password" name="" id="pass" value="" placeholder="å¯†ç " />
      <input type="button" name="" id="btn" value="æäº¤" />
    </form>
  </body>
  <script>
    var my = document.querySelector('#my')
    var pass = document.querySelector('#pass')
    var btn = document.querySelector('#btn')
    let xhr = new XMLHttpRequest()
    btn.onclick = function () {
      console.log(my.value, pass.value)
      xhr.open('post', 'http://localhost:8000/info')
      xhr.setRequestHeader('Content-Type', 'application/json')
        //å‚æ•°æ”¾åœ¨è¯·æ±‚ä½“ä¸­
      xhr.send(JSON.stringify({ name: my.value, pass: pass.value }))
      xhr.onload = function () {
        console.log(xhr.responseText)
      }
    }
```

## è§£å†³è·¨åŸŸ

```js
// è§£å†³è·¨åŸŸ
  response.setHeader('Access-Control-Allow-Origin', '*')
  // è§£å†³è®¾ç½®çš„å¤´éƒ¨
  response.setHeader('Access-Control-Allow-Headers', 'Content-Type')
```

æˆ–

```js
   res.writeHead(200, {
        "Access-Control-Allow-Origin": "http://localhost:3000",
        "Access-Control-Allow-Headers": "X-Token,Content-Type",
        "Access-Control-Allow-Methods": "GET,POST,PUT"
    });
```



## è¿æ¥æ•°æ®åº“

nodeä¸­ä½¿ç”¨éœ€è¦npmä¸‹è½½

npm install mongoose

ç„¶åå‘½ä»¤è¡Œnet start mongoDBå¯åŠ¨

åœ¨http2.jsä¸­ä½¿ç”¨ï¼š

```js
// model.js
const mongoose = require('mongoose')

// åˆ›å»ºé›†åˆè§„åˆ™
const courseSchema = new mongoose.Schema({
  name: String,
  age: Number,
})

// åˆ›å»ºé›†åˆå¹¶åº”ç”¨è§„åˆ™
const Course = mongoose.model('Course', courseSchema)

exports.Course = Course


//http2.js
const mongoose = require('mongoose')
const { Course } = require('./model')
if (url === '/' && method === 'GET') {
    fs.readFile('index.html', (err, data) => {
      response.writeHead(200, {
        'Content-Type': 'text/html',
      })
      mongoose
        .connect('mongodb://localhost/mytest')
        .then(() => {
          console.log('æ•°æ®åº“è¿æ¥æˆåŠŸ')
        })
        .catch((err) => console.log('æ•°æ®åº“è¿æ¥å¤±è´¥', err))
      Course.create({ name: 'xuxin', age: 19 })
        .then((doc) => console.log('æ’å…¥æ•°æ®æˆåŠŸ', doc))
        .catch((err) => console.log('æ’å…¥æ•°æ®å¤±è´¥', err))
      response.end(data)
    })
```

å¢åˆ æ”¹æŸ¥è§é»‘é©¬ppt

# æ¨¡å—

æ ¸å¿ƒï¼šä¸éœ€è¦requireã€‚å†…ç½®ï¼šä¸ç”¨installï¼Œéœ€è¦require

![node](F:\å›¾ç‰‡\node.png)

## ç¬¬ä¸‰æ–¹æ¨¡å—

### router

å®ç°è·¯ç”±

```
const getRouter = require('router')
const router = getRouter();
router.get('/add', (req, res) => {
    res.end('Hello World!')
}) 
server.on('request', (req, res) => {
    router(req, res)
})

```

### serve-static

å®ç°é™æ€èµ„æºè®¿é—®æœåŠ¡

```
const serveStatic = require('serve-static')
const serve = serveStatic('public')
server.on('request', () => { 
    serve(req, res)
})
server.listen(3000)

```



### 1.npm i download-git-repo -S

å®ç°ä»gitä¸Šå…‹éš†ä»£ç åˆ°æœ¬åœ°æ–‡ä»¶å¤¹ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å†™gitåœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°å†™æœ¬åœ°æ–‡ä»¶å¤¹åœ°å€ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å›è°ƒå‡½æ•°ï¼ŒæˆåŠŸæˆ–å¤±è´¥æ—¶æ‰§è¡Œ

### 2.npm i ora -S

å®ç°ä¸‹è½½æ—¶çš„æ˜¾ç¤ºè¿‡ç¨‹ï¼Œprocess = ora(ä¸‹è½½æ—¶æ˜¾ç¤ºçš„å†…å®¹) ï¼Œprocess.fail()æ˜¾ç¤ºå¤±è´¥å›¾æ ‡ï¼Œprocess.succeed()æ˜¾ç¤ºæˆåŠŸå›¾æ ‡

```
const repo = 'github:su37josephxia/vue-template';
const test = '../test';
clone(repo,test);
function clone(repo,test) {
  const download = require('download-git-repo')
  const ora = require('ora')
  const process = ora(`æ­£åœ¨ä¸‹è½½${repo}`)
  process.start()
  download(repo, test, err => {
    if (err) {
      process.fail()
         } else {
      process.succeed()
    }
  })
}
```

### 3.npm i util -S 

å®ç°å°†nodeè½¬å˜ä¸ºpromiseçš„å†™æ³•ï¼Œç”¨åŒæ­¥æ–¹å¼å†™å¼‚æ­¥ä»£ç 

```
const repo = 'github:su37josephxia/vue-template';
const test = '../test';
clone(repo,test);
 async function clone(repo,test) {
  const {promisify} = require('util')
  const download = promisify(require('download-git-repo'))
  const ora = require('ora')
  const process = ora(`æ­£åœ¨ä¸‹è½½${repo}`)
  process.start()
   try {
    await download(repo,test)
  } catch (error) {
    process.fail()
  }
  process.succeed()
 }
```

### æ¨¡å—å¯¼å‡ºå¯¼å…¥

exportsæ˜¯module.exportsçš„ä¸€ä¸ªå¼•ç”¨ï¼ŒexportsæŒ‡å‘çš„æ˜¯module.exports

```
module.exports.clone = async function.....
const {clone} = require('å¯¼å‡ºæ–‡ä»¶è·¯å¾„')
```

```js
//A.js
exports.add = add  === module.exports.add = add
//B.js
const {add} = require('A.js')
```

å¦‚æœ

```
module.exports = add
åˆ™ç›´æ¥
const add = require('A.js')
```



# æ ¸å¿ƒapi

### fsï¼šæ–‡ä»¶ç³»ç»Ÿ

```
const data = fs.readFileSync(è·¯å¾„) :åŒæ­¥è°ƒç”¨
const data = fs.readFile(è·¯å¾„ï¼Œ(err,data)=>{}): å¼‚æ­¥è°ƒç”¨
console.log(data) å®é™…ä¸Šè¯»å–çš„æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶buffer
å¦‚æœè¦è¯»å–çœŸæ­£çš„å†…å®¹ï¼šconsole.log(data.toString())
```

### Buffer(é‡è¦)

è¯»å–æ•°æ®ç±»å‹ä¸ºBuï¬€er **ç”±äºè¯»å–çš„æ•°æ®éƒ½æ˜¯äºŒè¿›åˆ¶å€¼ï¼Œä¸ºäº†æ“çºµè¿™ä¸ªäºŒè¿›åˆ¶å€¼ï¼Œéœ€è¦ä½¿ç”¨Bufferï¼ŒBuffer ç±»æ˜¯ç”¨æ¥å¤„ç†äºŒè¿›åˆ¶æ•°æ®**

å®é™…ä¸Šbufferé‡Œé¢å­˜çš„è¿˜æ˜¯ 0100011.... è¿™äº›ï¼Œ**åªä¸è¿‡æ¯8ä¸ªå­—èŠ‚æ˜¾ç¤ºæˆä¸€ä¸ª16è¿›åˆ¶æ•°å­—**æ¥ç»™ä½ çœ‹ï¼Œæ‰€ä»¥å½“ä½ çœŸæ­£ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦æŒ‡æ˜ç‰¹å®šçš„ç¼–è§£ç æ–¹å¼(é»˜è®¤utf8)

8bitï¼ˆä½ï¼‰ = 1 byteï¼ˆå­—èŠ‚ï¼‰ 

```
//åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º10å­—èŠ‚ä»¥0å¡«å……çš„Buffer
const buf1=Buffer.alloc(10);
console.log(buf1);

Buffer.allocï¼šåˆ†é…å†…å­˜ç©ºé—´ ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºå¤šå°‘å­—èŠ‚ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºä»¥ä»€ä¹ˆå¡«å……
æ¯”å¦‚Buffer.alloc(10,22)
åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º10å­—èŠ‚ä»¥åè¿›åˆ¶æ•°22å¡«å……çš„Buffer
22å…ˆè½¬æ¢ä¸ºäºŒè¿›åˆ¶ 10110ï¼Œç”±äºBufferçš„æ•°æ®æ˜¾ç¤ºæ˜¯ä»¥16è¿›åˆ¶æ˜¾ç¤ºçš„=>10110è½¬æ¢ä¸º16è¿›åˆ¶ä¸º16
æ‰€ä»¥æ˜¾ç¤ºä¸ºï¼š<Buffer 16 16 16 16 16 16 16 16 16 16>
```

```
//åˆ›å»ºä¸€ä¸ªBufferåŒ…å«ascii.
//asciiæŸ¥è¯¢http://ascii.911cha.com/
const buf2=Buffer.from('a')
console.log(buf2,buf2.toString())

Buffer.from: å°†æŸä¸ªå€¼è½¬æ¢æˆBufferæ•°æ®
```

åˆ›å»ºBufferåŒ…å«UTF-8å­—èŠ‚//UFT-8ï¼šä¸€ç§å˜é•¿çš„ç¼–ç æ–¹æ¡ˆï¼Œä½¿ç”¨1~6ä¸ªå­—èŠ‚æ¥å­˜å‚¨ï¼›

```
const buf3=Buffer.from('Bufferåˆ›å»ºæ–¹æ³•');
console.log(buf3);
```

å†™å…¥æ•°æ®

```
buf1.write('hello');console.log(buf1);
```

è¯»å–

```
console.log(buf3.toString());
```

åˆå¹¶

```
const buf4=Buffer.concat([buf1,buf3]);
```

bufferå¯ä»¥è¿›è¡Œç±»ä¼¼äºæ•°ç»„çš„æ“ä½œ

```js
const buf = Buffer.alloc(3)
buf[0] = 65
buf[1] = 66
buf[2] = 67
// å°†bufferæ•°æ®è½¬æ¢æˆå­—ç¬¦ä¸²
console.log(buf.toString('utf8'))
```



### http

```js
const http = require('http')
const fs = require('fs')
const server = http.createServer((request,response)=>{
  const {url,method} = request
  if(url === '/' && method === 'GET') {
    response.writeHead(200,{
      'Content-Type':'text/html'
    })
    response.end('hello')
  } else if(url === '/users'&& method === 'GET') {
    response.writeHead(200, {
      'Content-Type':'application/json'
    })
    response.end(JSON.stringify({
      name:'xiaoxu',
      age:'20'
    }))
  }
})
server.listen(3000)
```

ä½¿ç”¨httpåˆ›å»ºå®¢æˆ·ç«¯

```js
const http = require('http')
let responseData = ''
http.request({
  'host':'localhost',
  'port':9093,
  'method':'get'  
},res=>{
  res.on('data',(chunk)=>{
      responseData += chunk
  })
  res.on('end',()=>{
      console.log(responseData)
  })
}).end()
```



### streamæµæ“ä½œ(é‡è¦)

#### æµçš„åŸºæœ¬æ¦‚å¿µåŠç†è§£

**æµç»§æ‰¿äº†EventEmitterã€‚å› æ­¤æ‰€æœ‰çš„æµéƒ½æ˜¯EventEmitterçš„å®åˆ—ã€‚**

> æµæ˜¯ä¸€ç§æ•°æ®ä¼ è¾“æ‰‹æ®µï¼Œæ˜¯æœ‰é¡ºåºçš„ï¼Œæœ‰èµ·ç‚¹å’Œç»ˆç‚¹ï¼Œæ¯”å¦‚ä½ è¦æŠŠæ•°æ®ä»ä¸€ä¸ªåœ°æ–¹ä¼ åˆ°å¦å¤–ä¸€ä¸ªåœ°æ–¹
>  æµéå¸¸é‡è¦ï¼Œgulpï¼Œwebpack,HTTPé‡Œçš„è¯·æ±‚å’Œå“åº”ï¼Œhttpé‡Œçš„socketéƒ½æ˜¯æµï¼ŒåŒ…æ‹¬åé¢å‹ç¼©ï¼ŒåŠ å¯†ç­‰
>
> æµä¸ºä»€ä¹ˆè¿™ä¹ˆå¥½ç”¨è¿˜è¿™ä¹ˆé‡è¦å‘¢ï¼Ÿ

- å› ä¸ºæœ‰æ—¶å€™æˆ‘ä»¬ä¸å…³å¿ƒæ–‡ä»¶çš„ä¸»ä½“å†…å®¹ï¼Œåªå…³å¿ƒèƒ½ä¸èƒ½å–åˆ°æ•°æ®ï¼Œå–åˆ°æ•°æ®ä¹‹åæ€ä¹ˆè¿›è¡Œå¤„ç†
- å¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œæ¯”å¦‚grunt-file-copy
- **å¯¹äºä½“ç§¯è¾ƒå¤§çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ¯”å¦‚éŸ³é¢‘ã€è§†é¢‘æ–‡ä»¶ï¼ŒåŠ¨è¾„å‡ ä¸ªGBå¤§å°ï¼Œå¦‚æœä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œå¾ˆå®¹æ˜“ä½¿å†…å­˜â€œçˆ†ä»“â€ã€‚**
- **ç†æƒ³çš„æ–¹æ³•åº”è¯¥æ˜¯è¯»ä¸€éƒ¨åˆ†ï¼Œå†™ä¸€éƒ¨åˆ†ï¼Œä¸ç®¡æ–‡ä»¶æœ‰å¤šå¤§ï¼Œåªè¦æ—¶é—´å…è®¸ï¼Œæ€»ä¼šå¤„ç†å®Œæˆï¼Œè¿™é‡Œå°±éœ€è¦ç”¨åˆ°æµçš„æ¦‚å¿µ**

> æµæ˜¯ä¸€ä¸ªæŠ½è±¡æ¥å£ï¼Œè¢«Nodeä¸­å¾ˆå¤šå¯¹è±¡æ‰€å®ç°ï¼Œæ¯”å¦‚HTTPæœåŠ¡å™¨requestå’Œresponseå¯¹è±¡éƒ½æ˜¯æµ
>
> Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š

- Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
- Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
- Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
- Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).

#### Readable streamså¯è¯»æµ

> å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ï¼ˆsourceï¼‰çš„æŠ½è±¡
>  å¯è¯»æµçš„ä¾‹å­åŒ…æ‹¬ï¼š

- **HTTP responses, on the client ï¼šå®¢æˆ·ç«¯è¯·æ±‚**
- **HTTP requests, on the server ï¼šæœåŠ¡ç«¯è¯·æ±‚**

æ¯”å¦‚ï¼š

```js
 const server = http.createServer((request,response)=>{
   const {url,method,headers} = request
   if(method='POST'){
    let postData = ''
    // requestå³ä¸ºæµ chunkä»£è¡¨å®¢æˆ·ç«¯æºæºä¸æ–­å‘é€æ¥çš„æ•°æ®
    request.on('data',(chunk)=>postData+=chunk)
    request.on('end',()=>{
     console.log(querystring.parse(postData))
    })
   }
 })
```



- **fs read streams ï¼šè¯»æ–‡ä»¶**
- zlib streams ï¼šå‹ç¼©
- crypto streams ï¼šåŠ å¯†
- **TCP sockets ï¼šTCPåè®®**
- **child process stdout and stderr ï¼šå­è¿›ç¨‹æ ‡å‡†è¾“å‡ºå’Œé”™è¯¯è¾“å‡º**
- process.stdin ï¼šæ ‡å‡†è¾“å…¥

> ä¸‹é¢ç®€å•ä¸¾ä¸ªå¯è¯»æµçš„ä¾‹å­ï¼š

- **ç›‘å¬å¯è¯»æµçš„dataäº‹ä»¶**ï¼Œå½“ä½ ä¸€æ—¦å¼€å§‹ç›‘å¬dataäº‹ä»¶çš„æ—¶å€™ï¼Œæµå°±å¯ä»¥è¯»æ–‡ä»¶çš„å†…å®¹å¹¶ä¸”å‘å°„dataï¼Œ**è¯»ä¸€ç‚¹å‘å°„ä¸€ç‚¹è¯»ä¸€ç‚¹å‘å°„ä¸€ç‚¹**
- é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä½ ç›‘å¬dataäº‹ä»¶ä¹‹åï¼Œä¼šä¸åœçš„è¯»æ•°æ®ï¼Œç„¶åè§¦å‘dataäº‹ä»¶ï¼Œè§¦å‘å®Œdataäº‹ä»¶åå†æ¬¡è¯»æ•°æ®
- **è¯»çš„æ—¶å€™ä¸æ˜¯æŠŠæ–‡ä»¶æ•´ä½“å†…å®¹è¯»å‡ºæ¥å†å‘å°„å‡ºæ¥çš„ï¼Œè€Œä¸”è®¾ç½®ä¸€ä¸ªç¼“å†²åŒºï¼Œå¤§å°é»˜è®¤æ˜¯64Kï¼Œæ¯”å¦‚æ–‡ä»¶æ˜¯128Kï¼Œå…ˆè¯»64Kå‘å°„å‡ºæ¥ï¼Œå†è¯»64Kåœ¨å‘å°„å‡ºæ¥ï¼Œä¼šå‘å°„ä¸¤æ¬¡**
- **ç¼“å†²åŒºçš„å¤§å°å¯ä»¥é€šè¿‡highWaterMarkæ¥è®¾ç½®**

ä¾‹å­ï¼š

**å¯è¯»æµï¼š**å¯è¯»æµé¦–å…ˆä¼šæ‰“å¼€æ–‡ä»¶->è§¦å‘æ–‡ä»¶openäº‹ä»¶ï¼Œç„¶åå°±å¼€å§‹ç–¯ç‹‚çš„è§¦å‘dataäº‹ä»¶è¯»å–ç»“æŸåä¼šè§¦å‘endäº‹ä»¶ï¼Œç„¶åå°†æ–‡ä»¶å…³é—­ï¼Œå¹¶ä¸”è§¦å‘closeäº‹ä»¶ã€‚

```js
const fs = require('fs');
//é€šè¿‡åˆ›å»ºä¸€ä¸ªå¯è¯»æµ
const rs = fs.createReadStream('./1.txt',{
  flags:'r',//æˆ‘ä»¬è¦å¯¹æ–‡ä»¶è¿›è¡Œä½•ç§æ“ä½œ
  mode:0o666,//æƒé™ä½
  encoding:'utf8',//ä¸ä¼ é»˜è®¤ä¸ºbufferï¼Œæ˜¾ç¤ºä¸ºå­—ç¬¦ä¸²
  start:3,//ä»ç´¢å¼•ä¸º3çš„ä½ç½®å¼€å§‹è¯»
  //è¿™æ˜¯æˆ‘çš„è§è¿‡å”¯ä¸€ä¸€ä¸ªåŒ…æ‹¬ç»“æŸç´¢å¼•çš„
  end:8,//è¯»åˆ°ç´¢å¼•ä¸º8ç»“æŸ
  highWaterMark:3//ç¼“å†²åŒºå¤§å°
});
rs.on('open',function () {
  console.log('æ–‡ä»¶æ‰“å¼€');
});
rs.setEncoding('utf8');//æ˜¾ç¤ºä¸ºå­—ç¬¦ä¸²
//å¸Œæœ›æµæœ‰ä¸€ä¸ªæš‚åœå’Œæ¢å¤è§¦å‘çš„æœºåˆ¶
rs.on('data',function (data) {
  console.log(data);
  rs.pause();//æš‚åœè¯»å–å’Œå‘å°„dataäº‹ä»¶
  setTimeout(function(){
    rs.resume();//æ¢å¤è¯»å–å¹¶è§¦å‘dataäº‹ä»¶
  },2000);
});
//å¦‚æœè¯»å–æ–‡ä»¶å‡ºé”™äº†ï¼Œä¼šè§¦å‘erroräº‹ä»¶
rs.on('error',function () {
  console.log("error");
});
//å¦‚æœæ–‡ä»¶çš„å†…å®¹è¯»å®Œäº†ï¼Œä¼šè§¦å‘endäº‹ä»¶
rs.on('end',function () {
  console.log('è¯»å®Œäº†');
});
rs.on('close',function () {
  console.log('æ–‡ä»¶å…³é—­');
});

```

å…¶ä¸­1.txtçš„å†…å®¹æ˜¯123456789

åˆ™æ‰“å°å‡ºæ¥çš„å†…å®¹æ˜¯ï¼š

```
/**
æ–‡ä»¶æ‰“å¼€
456
789
è¯»å®Œäº†
æ–‡ä»¶å…³é—­
**/
```

#### Writable streamså¯å†™æµ

> å¯å†™æµæ˜¯å¯¹æ•°æ®å†™å…¥'ç›®çš„åœ°'çš„ä¸€ç§æŠ½è±¡
>  Writableï¼šå¯å†™æµçš„ä¾‹å­åŒ…æ‹¬äº†ï¼š

- **HTTP requests, on the client  å®¢æˆ·ç«¯è¯·æ±‚**
- **HTTP responses, on the server æœåŠ¡å™¨å“åº”**
- **fs write streams æ–‡ä»¶**
- zlib streams å‹ç¼©
- crypto streams åŠ å¯†
- **TCP sockets TCPæœåŠ¡å™¨**
- **child process stdin å­è¿›ç¨‹æ ‡å‡†è¾“å…¥**
- process.stdout, process.stderr æ ‡å‡†è¾“å‡ºï¼Œé”™è¯¯è¾“å‡º

> ä¸‹é¢ä¸¾ä¸ªå¯å†™æµçš„ç®€å•ä¾‹å­

- **å½“ä½ å¾€å¯å†™æµé‡Œå†™æ•°æ®çš„æ—¶å€™ï¼Œä¸æ˜¯ä¼šç«‹åˆ»å†™å…¥æ–‡ä»¶çš„ï¼Œè€Œæ˜¯ä¼šå¾ˆå†™å…¥ç¼“å­˜åŒºï¼Œç¼“å­˜åŒºçš„å¤§å°å°±æ˜¯highWaterMark,é»˜è®¤å€¼æ˜¯16Kã€‚ç„¶åç­‰ç¼“å­˜åŒºæ»¡äº†ä¹‹åå†æ¬¡çœŸæ­£çš„å†™å…¥æ–‡ä»¶é‡Œ**

```javascript
let fs = require('fs');
let ws = fs.createWriteStream('./2.txt',{
   flags:'w',
   mode:0o666,
   start:3,
   highWaterMark:3//é»˜è®¤æ˜¯16K
});
```

- å¦‚æœç¼“å­˜åŒºå·²æ»¡ ï¼Œè¿”å›false,å¦‚æœç¼“å­˜åŒºæœªæ»¡ï¼Œè¿”å›true
- å¦‚æœèƒ½æ¥ç€å†™ï¼Œè¿”å›true,å¦‚æœä¸èƒ½æ¥ç€å†™ï¼Œè¿”å›false
- æŒ‰ç†è¯´å¦‚æœè¿”å›äº†false,å°±ä¸èƒ½å†å¾€é‡Œé¢å†™äº†ï¼Œä½†æ˜¯å¦‚æœä½ çœŸå†™äº†ï¼Œå¦‚æœä¹Ÿä¸ä¼šä¸¢å¤±ï¼Œä¼šç¼“å­˜åœ¨å†…å­˜é‡Œã€‚ç­‰ç¼“å­˜åŒºæ¸…ç©ºä¹‹åå†ä»å†…å­˜é‡Œè¯»å‡ºæ¥



```javascript
let flag = ws.write('1');
console.log(flag);//true
flag =ws.write('2');
console.log(flag);//true
flag =ws.write('3');
console.log(flag);//false è¿™é‡Œæ»¡3äº†ï¼Œæ‰€ä»¥è¿”å›false
flag =ws.write('4');
console.log(flag);//false
```

### **NodeJsçš„Bufferç¼“å­˜ä¸æµå¼æ“ä½œï¼ˆé‡è¦ï¼‰**

```
let fs = require("fs");

//åˆ›å»ºå¯è¯»æµ
let readF = fs.createReadStream("æ–‡ä»¶è·¯å¾„");
//åˆ›å»ºå¯å†™æµ
let writeF = fs.createWriteStream("æ–‡ä»¶è·¯å¾„2");
readF.on("data",function(data){
   writeF.write(data);
   //å†™å…¥å¯å†™æµ
});

readF.once("close",function(){
//ç›‘å¬å¯è¯»æµå…³é—­
    writeF.end();
    //å…³é—­å¯å†™æµ
});
```

ä¸Šé¢çš„ä»£ç å¯ä»¥ç›´æ¥é€šè¿‡pipeæ–¹æ³•è½¬æ¢æˆï¼š

```
readF.pipe(writeF)
```

#### é¡¹ç›®å°ä¾‹å­

```js
 
 // response.end('hello ...')
  const { url, method ,headers} = request
  if (url === '/' && method === 'GET'){
    // é™æ€é¡µé¢æœåŠ¡
    fs.readFile('index.html',(err,data) => {
      response.statusCode = 200
      response.setHeader('Content-Type','text/html')
      response.end(data)
    })
  }else if(url === '/users' && method === 'GET'){
    // AjaxæœåŠ¡
    response.writeHead(200,{
      'Content-Type': 'application/json'
    })
    response.end(JSON.stringify({
      name : 'laowang'
    }))
  }else if(method === 'GET' && headers.accept.indexOf('image/*') !== -1){
    // å›¾ç‰‡æ–‡ä»¶æœåŠ¡ index.htmlé‡Œæœ‰å›¾ç‰‡
    // ç”±äºæµè§ˆå™¨åœ¨è§£æhtmlæ—¶ï¼Œé‡åˆ°æœ‰å¤–é“¾èµ„æºçš„å±æ€§å¦‚srcã€hrefä¼šå‘èµ·ç¬¬äºŒè½®è¯·æ±‚
    // è¿™é‡Œçš„ headers.accept.indexOf('image/*') !== -1è¡¨æ˜æ˜¯è§£æåˆ°index.htmlçš„imgçš„ç¬¬äºŒè½®è¯·æ±‚
    // æ‰€ä»¥è¿™é‡Œçš„urlæ˜¯node.png
    fs.createReadStream('./'+url).pipe(response)
  }
  server.listen(3000)
  
  å›¾æ–‡æ–‡ä»¶æœåŠ¡é‡‡ç”¨æµæ“ä½œï¼Œå¦‚æœè®¿é—®3000/ï¼Œåˆ™ä»¥æµçš„æ–¹å¼æ¸²æŸ“å›¾ç‰‡
```

**Acceptä»£è¡¨å‘é€ç«¯ï¼ˆå®¢æˆ·ç«¯ï¼‰å¸Œæœ›æ¥å—çš„æ•°æ®ç±»å‹ã€‚æ¯”å¦‚ï¼šAcceptï¼štext/xml;ä»£è¡¨å®¢æˆ·ç«¯å¸Œæœ›æ¥å—çš„æ•°æ®ç±»å‹æ˜¯xmlç±»å‹ã€‚**
**Content-Typeä»£è¡¨å‘é€ç«¯ï¼ˆå®¢æˆ·ç«¯|æœåŠ¡å™¨ï¼‰å‘é€çš„å®ä½“æ•°æ®çš„æ•°æ®ç±»å‹ã€‚æ¯”å¦‚ï¼šContent-Typeï¼štext/html;ä»£è¡¨å‘é€ç«¯å‘é€çš„æ•°æ®æ ¼å¼æ˜¯htmlã€‚**

**äºŒè€…åˆèµ·æ¥ï¼ŒAccept:text/xmlï¼›Content-Type:text/htmlï¼Œå³ä»£è¡¨å¸Œæœ›æ¥å—çš„æ•°æ®ç±»å‹æ˜¯xmlæ ¼å¼ï¼Œæœ¬æ¬¡è¯·æ±‚å‘é€çš„æ•°æ®çš„æ•°æ®æ ¼å¼æ˜¯htmlã€‚**

# è‡ªå®šä¹‰cliå·¥å…·é“¾

 mkdir vue-auto-router-cli 

cd vue-auto-router-cli 

npminit-y

**vue-auto-router-cli æ–‡ä»¶ä¸‹å»ºbinæ–‡ä»¶å¤¹**

> binæ–‡ä»¶å¤¹é‡Œæ˜¯å¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶
>
> libæ–‡ä»¶å¤¹é‡Œæ˜¯åº“æ–‡ä»¶

**binæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºkkbæ–‡ä»¶**

```
#!/usr/bin/envnode
console.log('cli...')
```

åœ¨package.jsonä¸­æ·»åŠ 

```
"bin": {
    "kkb": "./bin/kkb"
  },
```

npm link

æ‰§è¡Œkkb

=> cli....

æ„å»ºï¼š

```
#!/usr/bin/envnode
const program = require('commander')
program.version(require('../package').version, '-v', '--version')
    .command('init <name>', 'init project')
    .command('refresh','refresh routers...')
program.parse(process.argv)
```

**å»ºç«‹kkb-initæ–‡ä»¶å¤¹**

```
#!/usr/bin/env node
const program = require('commander')
program
    .action(name => {
            console.log('init '+ name)
    })
program.parse(process.argv)
```

æ‰§è¡Œkkb init abc => init abc

**å°†apiæ–‡ä»¶å¤¹ä¸­çš„modulesdownload.jså¤åˆ¶åˆ°libæ–‡ä»¶å¤¹ä¸‹**

åœ¨kkb-initä¸­è°ƒç”¨

```
#!/usr/bin/env node
const program = require('commander')
const {clone} = require('../lib/modulesdownload.js')
program
    .action(async name => {
           // console.log('init '+ name)
            console.log('ğŸš€åˆ›å»ºé¡¹ç›®:' + name)
           // ä»githubå…‹éš†é¡¹ç›®åˆ°æŒ‡å®šæ–‡ä»¶å¤¹
            await clone('github:su37josephxia/vue-template',name)
    })
program.parse(process.argv)
```

ç„¶åç»ˆç«¯è¾“å…¥ kkb init testï¼Œåˆ›å»ºtestæ–‡ä»¶å¤¹æ¥clone gitä¸Šçš„é¡¹ç›®

ç»ˆç«¯è¿›å…¥testæ–‡ä»¶ï¼Œnpm i æ¥å®‰è£…åŒ…

npm run serveæ¥è¿è¡Œ

**å®ç°æ¯æ–°å»ºä¸€ä¸ªvueé¡µé¢ ï¼Œéƒ½è‡ªåŠ¨åˆ·æ–°ï¼Œæ·»åŠ åˆ°vueä¸»é¡µçš„å¯¼èˆªä¸Šå»**

**åŸç†**

æ¯å†™ä¸€ä¸ªvueé¡µé¢ï¼Œéƒ½è‡ªåŠ¨æ·»åŠ åˆ°router.js,å¹¶è‡ªåŠ¨æ·»åŠ åˆ°App.Vueçš„è·¯ç”±å ä½ç¬¦ä¸Šå»

1.å»ºç«‹kkb-refreshå®ç°

2.testç»ˆç«¯kkb refresh

3.åˆ·æ–°testç»ˆç«¯ï¼š npm run serve

# Express

è§é»‘é©¬ppt

åŸç”Ÿnodeä¸expressæ¯”è¾ƒï¼š

```js
//åŸç”Ÿ
app.on('request', (req, res) => {
     // è·å–å®¢æˆ·ç«¯çš„è¯·æ±‚è·¯å¾„
     let { pathname } = url.parse(req.url);
     // å¯¹è¯·æ±‚è·¯å¾„è¿›è¡Œåˆ¤æ–­ ä¸åŒçš„è·¯å¾„åœ°å€å“åº”ä¸åŒçš„å†…å®¹
     if (pathname == '/' || pathname == 'index') {
        res.end('æ¬¢è¿æ¥åˆ°é¦–é¡µ');
     } else if (pathname == '/list') {
        res.end('æ¬¢è¿æ¥åˆ°åˆ—è¡¨é¡µé¡µ');
     } else if (pathname == '/about') {
        res.end('æ¬¢è¿æ¥åˆ°å…³äºæˆ‘ä»¬é¡µé¢')
     } else {
        res.end('æŠ±æ­‰, æ‚¨è®¿é—®çš„é¡µé¢å‡ºæ¸¸äº†');
     }
 });

```

expressï¼š

```js
 // å½“å®¢æˆ·ç«¯ä»¥getæ–¹å¼è®¿é—®/æ—¶
 app.get('/', (req, res) => {
     // å¯¹å®¢æˆ·ç«¯åšå‡ºå“åº”
     res.send('Hello Express');
 });

 // å½“å®¢æˆ·ç«¯ä»¥postæ–¹å¼è®¿é—®/addè·¯ç”±æ—¶
 app.post('/add', (req, res) => {
    res.send('ä½¿ç”¨postæ–¹å¼è¯·æ±‚äº†/addè·¯ç”±');
 });

```

è¯·æ±‚å‚æ•°çš„å¯¹æ¯”ï¼š

åŸç”Ÿï¼šgeté€šè¿‡url.parse(req.url)è·å–ï¼Œposté€šè¿‡querystring.parse(postData)è·å–ï¼Œå¹¶ä¸”postDataæ˜¯ä»¥æµçš„æ–¹å¼é€æ­¥è·å–çš„

```js
//åŸç”Ÿ
app.on('request', (req, res) => {
    // è·å–GETå‚æ•°
    let {query} = url.parse(req.url, true);
    // è·å–POSTå‚æ•°
    let postData = '';
    req.on('data', (chunk) => {
        postData += chunk;
    });
    req.on('end', () => {
        console.log(querystring.parse(postData)
    })); 
 });

```

expressï¼šgetç›´æ¥é€šè¿‡req.queryè·å–ï¼Œpostéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—body-parser

```js
// å¼•å…¥body-parseræ¨¡å—
 const bodyParser = require('body-parser');
 // é…ç½®body-parseræ¨¡å—
 app.use(bodyParser.urlencoded({ extended: false }));

app.get('/', (req, res) => {
    // è·å–GETå‚æ•°
    console.log(req.query);
 });

 app.post('/', (req, res) => {
    // è·å–POSTå‚æ•°
    console.log(req.body);
 }) 

```

expressè·å–è·¯ç”±å‚æ•°é€šè¿‡req.paramsè·å–ï¼š

```js
app.get('/find/:id', (req, res) => { 
     console.log(req.params); // {id: 123} 
 });
localhost:3000/find/123
```

**æ¨¡å—åŒ–è·¯ç”±**

```js
const express = require('express')
//åˆ›å»ºè·¯ç”±å¯¹è±¡
const home = express.Router()
//å°†è·¯ç”±å’Œè¯·æ±‚è·¯å¾„è¿›è¡ŒåŒ¹é…
app.use('/home',home)
home.get('/index',()=>{
    /home/index
    res.send('xxxx')
})
```



## ä¸­é—´ä»¶

å¯ä»¥é’ˆå¯¹åŒä¸€ä¸ªè¯·æ±‚è®¾ç½®å¤šä¸ªä¸­é—´ä»¶ï¼Œå¯¹åŒä¸€ä¸ªè¯·æ±‚è¿›è¡Œå¤šæ¬¡å¤„ç†ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯·æ±‚ä»ä¸Šåˆ°ä¸‹ä¾æ¬¡åŒ¹é…ä¸­é—´ä»¶ï¼Œä¸€æ—¦åŒ¹é…æˆåŠŸï¼Œç»ˆæ­¢åŒ¹é…ã€‚

å¯ä»¥è°ƒç”¨nextæ–¹æ³•å°†è¯·æ±‚çš„æ§åˆ¶æƒäº¤ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œç›´åˆ°é‡åˆ°ç»“æŸè¯·æ±‚çš„ä¸­é—´ä»¶ã€‚

```js
// é’ˆå¯¹æŸä¸€ä¸ªç‰¹å®šè·¯ç”±
app.type(url,(req,res,next)=>{
    xxxxx
    next()
})
// é’ˆå¯¹æ‰€æœ‰è·¯ç”±
app.use((req,res,next)=>{
    xxx
    next()
})
```

### å®é™…åº”ç”¨

- æ‰˜ç®¡é™æ€æ–‡ä»¶ï¼šexpresså†…ç½®express.static/koaçš„koa-static

```js
const path = require('path')
app.use(express.static(path.join(__dirname,'public')))

const koaStatic  = require('koa-static')
app.use(koaStatic('./public'))//æ‹¬å·ä¸­æ˜¯è®¾ç½®çš„é™æ€æ–‡ä»¶è·¯å¾„
```

- è§£æpostè¯·æ±‚å¸¦æ¥çš„å‚æ•°ï¼Œç®€åŒ–postè¯·æ±‚æ—¶å¯¹è¯·æ±‚æŠ¥æ–‡ä¸»é¢˜äºŒè¿›åˆ¶æ•°æ®æµçš„ç›‘å¬ï¼ˆreq.on('data',data=>{xxxx}),ä»¥åŠä¸€ç³»åˆ—éœ€è¦æµçš„æ“ä½œï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹æ¨¡å—body-parser

```js
const bodyParser = require('body-parser');
app.use(bodyParser.json());//postä¸‹è§£æjsonæ ¼å¼æ•°æ®
app.use(bodyParser.urlencoded({extended: false}));//postä¸‹è§£æxx=xx&yy=yyæ ¼å¼æ•°æ®

app.post('/first',(req,res)=>{
  res.send(req.body);
})
```

- mongoose
- cookie-parser

ç”¨æ¥æ“ä½œcookie

- jwt

ç”¨äºè®¤è¯httpè¯·æ±‚ï¼Œç”Ÿæˆtoken